{% extends 'base.html' %}
{% load static %}

{% block css %}
    <link href="{% static 'css/home.css' %}" rel="stylesheet">
{% endblock %}

{% block js %}
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>

    <script type="text/javascript" defer>
        window.onload = function() {
            document.getElementById('load-graphic').setAttribute('class', '');
            document.getElementById('graphic').setAttribute('class', 'd-none');
            document.getElementById('div-graphic').setAttribute('class', 'col-lg-7 col-11 d-flex justify-content-center align-items-center');

            // Setando um timeout para habilitar o carregamento do grafico (efeito visual)
            setTimeout(() => {
              document.getElementById('div-graphic').setAttribute('class', 'col-lg-7 col-11');
              document.getElementById('load-graphic').setAttribute('class', 'd-none');
              document.getElementById('graphic').setAttribute('class', '');


              fetch('/api/quotationcoin-graphic/', {method: 'GET'})
              .then(response => response.json())
              .then((obj) => {
                series_list = [];

                obj['coins'].forEach((obj_coin) => {
                  // filtra os valores de dados de acordo com o acronimo das siglas
                  values = obj['graphic'].filter(val => (val['coin'] == obj_coin['acronym']));

                  let values_list_cotation = [];
                  values.forEach((val) => {
                    values_list_cotation.push(val['data']['value'])
                  });

                  dict_serie = {
                    'name': obj_coin['name'],
                    'data': values_list_cotation
                  };

                  series_list.push(dict_serie)
                });

                Highcharts.chart('container', {
                    chart: {
                      type: 'line'
                    },
                    title: {
                      text: ''
                    },
                    subtitle: {
                      text: ''
                    },
                    xAxis: {
                      categories: obj['dates']
                    },
                    yAxis: {
                      title: {
                        text: 'Cotação (1 USD)'
                      }
                    },
                    plotOptions: {
                      line: {
                        dataLabels: {
                          enabled: true
                        },
                        enableMouseTracking: true
                      }
                    },
                    series: series_list
                });
              });
            }, 600);


        };
    </script>

{% endblock %}

{% block content %}
    <div class="d-flex mt-5 flex-wrap-reverse justify-content-center">
        <div class="col-lg-3 col-9 pb-lg-0">
            <h4 class="text-center title-filtro mb-3">Filtrar por</h4>
            <div class="mb-3">
                <label for="initial-date" class="label color-green-theme">Data inicial</label>
                <input type="date" name="initial-date" id="initial-date" class="form-control" />
            </div>
            <div class="mb-3">
                <label for="end-date" class="label color-green-theme">Data final</label>
                <input type="date" name="end-date" id="end-date" class="form-control" />
            </div>
            <div class="mb-3">
                <label for="coin" class="label color-green-theme">Moeda</label>
                <select name="coin" id="coin" class="form-select">
                    <option value="1">Real</option>
                    <option value="1">Euro</option>
                    <option value="1">Iene</option>
                </select>
            </div>
            <div class="mb-3 text-center">
{#                <input type="submit" value="Filtrar" class="form-control btn btn-outline-green-theme" />#}
                <button class="btn btn-outline-green-theme" type="button">
                  <span class="spinner-grow spinner-grow-sm d-none" aria-hidden="true"></span>
                  <span role="status">Filtrar</span>
                </button>
            </div>
        </div>
        <div class="col-lg-7 col-11" id="div-graphic">
            <div id="load-graphic" class="">
                <span class="spinner-grow spinner-grow-sm" aria-hidden="true"></span>
                <span>Carregando...</span>
            </div>

            <div id="graphic" class="">
                <figure class="highcharts-figure">
                    <div id="container"></div>
                </figure>
            </div>

        </div>
    </div>
{% endblock content %}